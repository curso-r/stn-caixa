# Quadro analítico histórico 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE, 
  eval = TRUE
)
library(ggaluvial)
library(tidyverse)
```


## Disponibilidades Líquidas

Para responder as questões (a) e (b) sobre disponibilidades líquidas das UGs, elaboramos:

- Gráficos das séries temporais das disponibilidades líquidas de cada UG e Fonte de Recurso.
- Gráficos das séries temporais das disponibilidades líquidas consolidadas por UG.

Aplicativo: [Explorador das séries temporais das disponibilidades líquidas](https://rseis.shinyapps.io/explorador_disponibilidades_liquidas)

- Indicador de disponibilidade líquida acumulante para as UGs.

### Indicador disponibilidade líquida acumulante por UG

**1) Disponibilidades Líquidas Acumulantes:** Indicador que apresenta valor alto quando uma UG apresenta disponibilidade líquida que apenas cresce com o passar do tempo para uma determinada fonte de recurso.

```{r, fig.width= 10, fig.cap="Disponibilidade líquida por fonte de recursos do CONSELHO ADMINISTRATIVO DE DEFESA ECONÔMICA. A fonte RECURSOS NÃO-FINANCEIROS DIRETAMENTE ARRECADADOS (linha verde) é um exemplo de disponibilidade líquida acumulante."}
disponibilidades_liquidas_diarias <- read_rds("../data/disponibilidades_liquidas_diarias.rds")
indicadores <- read_rds("../data/indicadores.rds")

ug_fonte_do_grafico <- indicadores %>% ungroup() %>% slice(2)

disponibilidades_liquidas_diarias %>%
  filter(
    NO_UG %in% ug_fonte_do_grafico$NO_UG
  ) %>%
  ggplot(aes(x = NO_DIA_COMPLETO_dmy, y = disponibilidade_liquida, colour = NO_FONTE_RECURSO)) +
  geom_line() +
  labs(y = "Disponibilidade Líquida", x = "Data", colour = "Fonte de Recurso")

```

Definição do indicador: $P_1 + P_2$

em que 

$$
P_1 = \frac{1}{N}\sum I(y_i > y_{i - 1})
$$

e **para quando a disponibilidade diminui**

$$
P_2 = \frac{1}{N_{y_i < y_{i - 1}}}\sum I(|y_i -y_{i - 1}| < \sigma)
$$

Em outras palavras, o indicador aponta curvas crescentes ($P_1$) permitindo pequenas perturbações ($P_2$).

Abaixo estão as UGs com os maiores valores do indicador, e suas respectivas fontes de recursos:

```{r, echo = FALSE, message=FALSE, warning=FALSE}
indicadores %>%
  ungroup %>%
  select(NO_UG, NO_FONTE_RECURSO, disponibilidade_estritamente_crescente) %>%
  distinct() %>%
  slice(2:10) %>%
  set_names(c("UG", "Fonte de Recursos", "Indicador")) %>%
  knitr::kable(digits = 2) 
```



## Classificações Orçamentárias e Financeiras

Destino das fontes de recursos e suas respectivas funções.

```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.width=12}

vinculacao_de_pagamentos <- read_rds(path = "../data/vinculacao_de_pagamentos.rds")

library(ggalluvial)
library(ggrepel)

dados <- vinculacao_de_pagamentos %>%
  ungroup() %>%
  filter(NO_DIA_COMPLETO == first(NO_DIA_COMPLETO), pagamento_positivo) %>%
  dplyr::group_by(
    NO_FUNCAO_PT, 
    NO_VINCULACAO_PAGAMENTO,
    NO_FONTE_RECURSO
  ) %>%
  summarise(
    pagamento = abs(sum(pagamento))
  )

dados %>%
  filter(pagamento > 200000) %>%
  ggplot(aes(
    y = pagamento, 
    axis1 = NO_FONTE_RECURSO,
    axis2 = NO_VINCULACAO_PAGAMENTO,
    axis3 = NO_FUNCAO_PT
  )) +
  stat_alluvium(width = 1/12, alpha = 0.5, aes(fill = NO_VINCULACAO_PAGAMENTO), show.legend = FALSE) +
  scale_x_discrete(limits = c("NO_FONTE_RECURSO", "NO_VINCULACAO_PAGAMENTO", "NO_FUNCAO_PT"), expand = c(0.05, 0.05)) +
  stat_stratum(width = 1/12, show.legend = FALSE) +
  geom_label_repel(stat = "stratum", infer.label = TRUE, size = 4)
```

- Todas as fontes de recursos são repartidas entre **previdência social** e **segurança pública**;
- Porém, se a função for **INSS - EPU CUSTEIO**, o recurso é destinado a Previdência social.

## Comportamento do Caixa por Movimentação

- Gráficos das séries temporais dos saldos e obrigações de cada UG e Fonte de Recurso.
- Gráficos das séries temporais dos saldos e obrigações consolidados por UG.
- Gráfico dos tempos entre duas movimentações de grande porte por UG e por Órgão.

Aplicativo: [Explorador das séries temporais das disponibilidades líquidas](https://rseis.shinyapps.io/explorador_disponibilidades_liquidas)
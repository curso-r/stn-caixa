# Disponibilidades Líquidas

```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE, 
  eval = TRUE
)
library(ggalluvial)
library(tidyverse)
theme_set(theme_minimal(12))


disponibilidades_liquidas_diarias <- read_rds("../data/disponibilidades_liquidas_diarias.rds")
obrigacoes_a_pagar_diarias <- read_rds("../data/obrigacoes_a_pagar_diarias.rds")
indicadores <- read_rds("../data/indicadores.rds")

trinta_e_uns_de_dezembro <- tibble(
  NO_DIA_COMPLETO_dmy = as.Date(c("2017-12-31", "2018-12-31", "2019-12-31"))
)

```

Para responder a questão (a)[a. Qual o comportamento do caixa e das obrigações a pagar (e da disponibilidade líquida) no período analisado?] sobre disponibilidades líquidas das UGs e as respectivas fontes de recursos, elaboramos os seguintes indicadores:

- **Indicador de acumulação de disponibilidade líquida:** acusa potencial problema de UGs que estariam recebendo recursos de fontes que já apresentava valores acumulados.

- **Indicador de persistência de saldo positivo:** acusa potencial problema de recurso estacionado por longo período.

Anexo ao relatório, a tabela **"indicadores.csv"** contém a lista de todas as UGs e fontes de recursos e seus respectivos valores dos indicadores.

```{r, echo=FALSE}
# salva o arquivo final dos indicadores
indicadores %>%
  select(NO_ORGAO, NO_FONTE_RECURSO, NO_UG, IADL = disponibilidade_estritamente_crescente, IPSP = integral_sobre_media_dos_gastos) %>%
  write_csv("../data/indicadores.csv")
```


## Indicador de acumulação de disponibilidade líquida ($I_{ADL}$)

Indicador que apresenta valor alto quando uma UG apresenta disponibilidade líquida que apenas cresce com o passar do tempo para uma determinada fonte de recurso.

### Definição

Seja $y_i$ a disponibilidade líquida no dia $i$,

$I_{ADL} = P_1 + P_2$

em que 

$$
P_1 = \frac{1}{N}\sum I(y_i > y_{i - 1})
$$

e **para quando a disponibilidade diminui**

$$
P_2 = \frac{1}{N_{y_i < y_{i - 1}}}\sum I(|y_i -y_{i - 1}| < \sigma)
$$

Em outras palavras, o indicador aponta curvas crescentes ($P_1$) permitindo pequenas perturbações ($P_2$).

### Exemplos

Abaixo estão as três curvas com os maiores valores de $I_{ADL}$:

```{r, echo = FALSE, message=FALSE, warning=FALSE}
##
orgaos_sorteados <- indicadores  %>%
  ungroup %>%
  arrange(desc(disponibilidade_estritamente_crescente)) %>%
  distinct(NO_ORGAO, NO_FONTE_RECURSO, NO_UG, disponibilidade_estritamente_crescente) %>%
  head(3) 

orgaos_sorteados %>%
  set_names(c("Órgão", "Fonte de Recursos", "UG", "IADL")) %>%
  knitr::kable(digits = 2) 
```

```{r, fig.width=7, fig.height=6}
## series
disponibilidades_liquidas_diarias  %>%
  ungroup %>%
  semi_join(orgaos_sorteados) %>%
  mutate(
    disponibilidade_liquida = disponibilidade_liquida/1e6
  ) %>%
  ggplot(aes(y = disponibilidade_liquida, x = NO_DIA_COMPLETO_dmy)) +
  geom_line(aes(group = NO_UG), colour = "salmon", show.legend = FALSE) +
  facet_wrap(~NO_FONTE_RECURSO + NO_ORGAO, scales = "free_y", ncol = 1) +
  geom_vline(data = trinta_e_uns_de_dezembro, aes(xintercept = NO_DIA_COMPLETO_dmy), colour = "purple", linetype = "dashed", size = 0.2) +
  scale_y_continuous(labels = scales::dollar_format(0.1, prefix = "", big.mark = ".", decimal.mark = ",", suffix = "")) +
  labs(x = "Data", y = "Disponibilidade líquida (milhões de reais)") +
  ylim(c(0, NA))

```

## Indicador de persistência de saldo positivo ($I_{PSP}$)

Indicador com valores altos para as curvas que apresentarem saldos positivos por longa duração de tempo no acumulado do período analisado.

### Definição

Área sob a curva de disponibilidade líquida ponderada pela soma de todas as obrigações pagas. 

Seja $y_i$ a disponibilidade líquida no dia $i$ e $o_i$ as obrigações pagas no dia $i$,

$$
I_{PSP} = \frac{\sum y_i}{\sum o_i}
$$

### Exemplos

Abaixo estão as três curvas com os maiores valores de $I_{PSP}$:

```{r, echo = FALSE, message=FALSE, warning=FALSE}
##
orgaos_sorteados <- indicadores  %>%
  ungroup %>%
  arrange(desc(integral_sobre_media_dos_gastos)) %>%
  distinct(NO_ORGAO, NO_FONTE_RECURSO, NO_UG, disponibilidade_estritamente_crescente) %>%
  head(3) 

orgaos_sorteados %>%
  set_names(c("Órgão", "Fonte de Recursos", "UG", "IPSP")) %>%
  knitr::kable(digits = 2) 
```

```{r, fig.width=7, fig.height=6}
## series
disponibilidades_liquidas_diarias  %>%
  ungroup %>%
  semi_join(orgaos_sorteados) %>%
  mutate(
    disponibilidade_liquida = disponibilidade_liquida/1e6
  ) %>%
  ggplot(aes(y = disponibilidade_liquida, x = NO_DIA_COMPLETO_dmy)) +
  geom_line(aes(group = NO_UG), colour = "salmon", show.legend = FALSE) +
  geom_area(aes(group = NO_UG), fill = "salmon", alpha = 0.3, show.legend = FALSE) +
  facet_wrap(~NO_FONTE_RECURSO + NO_ORGAO, scales = "free_y", ncol = 1) +
  geom_vline(data = trinta_e_uns_de_dezembro, aes(xintercept = NO_DIA_COMPLETO_dmy), colour = "purple", linetype = "dashed", size = 0.2) +
  scale_y_continuous(labels = scales::dollar_format(0.1, prefix = "", big.mark = ".", decimal.mark = ",", suffix = "")) +
  labs(x = "Data", y = "Disponibilidade líquida (milhões de reais)") +
  ylim(c(0, NA))

```

## Distribuição dos indicadores

Vamos analisar a distribuição dos indicadores em alguns níveis.

### Ug/Fonte

- gráfico de jitter
- alguma descricao em texto do tipo 30% das UG/Fonte tem valor acima de x que é considerado alto...
- histograma
- alguns exemplos de cada faixa

### UG

- gráfico de jitter
- histograma
- alguns exemplos de cada faixa

### Fonte

- gráfico de jitter
- histograma
- alguns exemplos de cada faixa
- destacar a fonte 'recursos ordinários'

## Indicador de Valor Nominal (R$)

O valor nominal indica o montante que a UG possui disponível em caixa. Quanto maior o excedente de caixa de uma UG, maior a tendência ao empoçamento.

### Definição

O indicador de valor nominal no mês $t$ é definido simplesmente pela disponibilidade líquida no fim do período.

$$IVN_t = DisponibilidadeLíquida_t$$
### Exemplos

### Distribuição

## Indicador de disponibilidade líquida projetada por 12 meses

A disponibilidade líquida mostra o caixa atual de uma UG considerando os pagamentos que foram aprovados até aquele mês (mesmo que ainda não tenham sido realizados). Para ser mais conservador consideramos neste índice os pagamentos que seriam aprovados até os próximos 12 meses - assim sendo, uma UG que ternha valores positivos neste indicador tinha no momento $t$ um excedente de caixa maior do que o que ela precisaria nos próximos 12 meses.

### Definição

O indicador é definido da seguinte maneira:

$$IDL_{12m} = DisponibilidadeBruta_t - \sum_{i=t}^{t+12}Pagamentos_i$$

### Exemplos
### Distribuição

## Indicador de Tempo

Este indicador considera o tempo que uma UG permanece com disponibilidade líquida positiva. Quando uma UG permanece por muito tempo com disponibilidade positiva isso pode indicar que existe *empoçamento*.

### Definição

O indicador é definido por:

$$IT = \sum I(DisponibilidadeLíquida_t > 0)$$

### Exemplos
### Distribuição

## Indicador de Variação da Disponibilidade Líquida

A taxa de variação da Disponibilidade Líquida com relação ao mesmo período do ano anterior tem como objetivo encontrar UG's que tiveram aumento no excedente de caixa, podendo indicar que existe *empoçamento*.

### Definição

O indicador é definido por:

$$IVDL_t = \prod_{i=1}^{12}(1 + T_i)^{1/12}$$

Em que:

$$T_i = \frac{DisponibilidadeLíquida_i}{DisponibilidadeLíquida_{i-12}}$$

### Exemplos

### Distribuição


